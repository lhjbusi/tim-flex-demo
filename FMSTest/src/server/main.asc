load("netservices.asc");
application.onAppStart = function() {
};
// 用户连接列表
var clientList = new Object();
// 用户请求列表
var requestList = new Object();
application.onConnect = function(client, userId, userName) {
	if (userId == null || userName == null) {
		return false;
	}
	// 关联用户编号
	client.userId = userId;
	// 关联用户名称
	client.userName = userName;

	client.sendRequest = function(receiveId, requestType) {
		// 获取所有在线用户
		var onlineUsers=SharedObject.get("onlineUser", true);
		// 获取被请求对象的连接
		var loginInfo = onlineUsers.getProperty(receiveId);
		// 不存在的用户
		if (loginInfo == null) {
			client.call("userIsOffline", null);
			return;
		}
		// 获取当前用户的请求列表
		var myRequest = client.reqList;
		if (myRequest == null) {
			myRequest = new Object();
		}
		// 获取与被请求人相关的请求
		var reqInfo = myRequest[receiveId];

		var otherClient = clientList[receiveId];
		// 调用被请求者客户端方法-通知被请求者
		otherClient.call("calleeConfirm", null, client.userId, client.userName, requestType);
		// 告知请求者,用户正在处理聊天请求
		client.call("sendRequestResult", null, otherClient.userId, requestType);
	}
	client.sendRequestStatus = function(callerId, requestType, status) {
		// 获取对应连接属性
		var otherClient=clientList[callerId];
		otherClient.call("requestStatusResult", null, client.userId, client.userName, requestType, status);
	}

	// 获取所有在线用户
	var onlineUsers=SharedObject.get("onlineUser", true);
	// 获取对应连接属性
	var loginInfo=onlineUsers.getProperty(userId);
	if (loginInfo != null) {// 有连接记录
		trace(userId+"重复初始化进来");
		clearInterval(loginInfo);
		// 获取原有连接个数
		var loginCount=loginInfo.count;
		if (loginCount > -1) {
			// 连接数+1
			loginInfo.count = loginCount+1;
		}
		// 用户连接关联
		client.count = loginInfo.count;
	} else {// 没有连接记录
		trace("loginInfo is null")
		// 发布时,这里就是标记用户是否在线的了，取消下行注释
		// client.call("userIsOffline", null);
		// 记录连接次数为1
		client.count = 1;
		var loginInfo = new Object();
		loginInfo.count = 1;
	}
	// 重置登陆信息
	onlineUsers.setProperty(userId, loginInfo);
	// 将共享数据写入硬盘
	onlineUsers.flush();

	// 记录当前连接
	clientList[userId] = client;
	application.acceptConnection(client);
}
application.onDisconnect = function(client) {
	// 获取所有在线用户
	var onlineUsers=SharedObject.get("onlineUser", true);
	try{
		// 获取对应连接属性
		var loginInfo=onlineUsers.getProperty(client.userId);
		if (loginInfo.count > 1) {// 还有其它登陆信息
			loginInfo.count = loginInfo.count - 1;
			onlineUsers.setProperty(client.userId, loginInfo);
		} else if (loginInfo.count == 1) {// 全部退出
			var intervalId = setInterval(function() {
				trace(client.userId+"离开");
				NetServices.setDefaultGatewayUrl('http://192.168.1.138/CG/home.do?p=logoutFromFlash&userID='+client.userId);
				var conn = NetServices.createGatewayConnection();
				conn.call("");
				clearInterval(intervalId);
			}, 10000);
			onlineUsers.setProperty(client.userId, intervalId);
			onlineUsers.lock();
			onlineUsers.setProperty("onlineUser", onlineUsers);
			onlineUsers.unlock();
			onlineUsers.flush();
		} else {
			onlineUsers.clear();
			onlineUsers.flush();
		}
	} catch(e) {
		onlineUsers.clear();
		onlineUsers.flush();
	}
}
